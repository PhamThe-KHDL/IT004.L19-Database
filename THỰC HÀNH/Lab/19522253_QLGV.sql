--TUAN 01--

---BAI TAP 02---
--CAU I.1-----------------------------------------------
CREATE DATABASE QuanLyGiaoVu
GO 
SET DATEFORMAT DMY
USE QuanLyGiaoVu

--TAO BANG HOCVIEN

CREATE TABLE HOCVIEN
(
	MAHV char(5) NOT NULL,
	HO varchar(40),
	TEN varchar(10),
	NGSINH smalldatetime,
	GIOITINH varchar(3),
	NOISINH varchar(40),
	MALOP varchar(3)
)

--TAO BANG LOP
CREATE TABLE LOP
(
	MALOP varchar(3) NOT NULL,
	TENLOP varchar(40),
	TRGLOP varchar(5),
	SISO tinyint,
	MAGVCN varchar(4)
)

--TAO BANG KHOA
CREATE TABLE KHOA
(
	MAKHOA varchar(4) NOT NULL,
	TENKHOA varchar(40),
	NGTLAP smalldatetime,
	TRGKHOA varchar(4)
)

--TAO BANG MONHOC
CREATE TABLE MONHOC
(
	MAMH varchar(10) NOT NULL,
	TENMH varchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA varchar(4)
)

--TAO BANG DIEUKIEN

CREATE TABLE DIEUKIEN
(
	MAMH varchar(10) NOT NULL,
	MAMH_TRUOC varchar(10) NOT NULL
)

--TAO BANG GIAOVIEN
CREATE TABLE GIAOVIEN
(
	MAGV varchar(4) NOT NULL,
	HOTEN varchar(40),
	HOCVI varchar(10),
	HOCHAM varchar(10),
	GIOITINH varchar(3),
	NGSINH smalldatetime,
	NGVL smalldatetime,
	HESO numeric(4,2),
	MUCLUONG money,
	MAKHOA varchar(4)
)

--TAO BANG GIANGDAY
CREATE TABLE GIANGDAY
(
	MALOP varchar(3) NOT NULL,
	MAMH varchar(10) NOT NULL,
	MAGV varchar(4),
	HOCKI tinyint,
	NAM smallint,
	TUNGAY smalldatetime,
	DENNGAY smalldatetime
)

--TAO BANG KETQUATHI
CREATE TABLE KETQUATHI
(
	MAHV char(5) NOT NULL,
	MAMH varchar(10) NOT NULL,
	LANTHI tinyint NOT NULL,
	NGTHI smalldatetime,
	DIEM numeric(4,2),
	KQUA varchar(10)
)
--XOA RBTV TRUOC KHI XOA BANG GIAOVIEN VA BANG KHOA
ALTER TABLE KHOA 
DROP CONSTRAINT FK_KHOA_TK
DROP TABLE KHOA
DROP TABLE GIAOVIEN

--XOA BANG

DROP TABLE HOCVIEN
DROP TABLE LOP

DROP TABLE MONHOC
DROP TABLE DIEUKIEN

DROP TABLE GIANGDAY
DROP TABLE KETQUATHI

--TAO KHOA CHINH

ALTER TABLE HOCVIEN 
ADD CONSTRAINT PK_HV PRIMARY KEY (MAHV)

ALTER TABLE LOP 
ADD CONSTRAINT PK_LOP PRIMARY KEY (MALOP)

ALTER TABLE KHOA 
ADD CONSTRAINT PK_KHOA PRIMARY KEY (MAKHOA)

ALTER TABLE MONHOC 
ADD CONSTRAINT PK_MH PRIMARY KEY (MAMH)

ALTER TABLE DIEUKIEN 
ADD CONSTRAINT PK_DK PRIMARY KEY (MAMH,MAMH_TRUOC)

ALTER TABLE GIAOVIEN 
ADD CONSTRAINT PK_GV PRIMARY KEY (MAGV)

ALTER TABLE GIANGDAY 
ADD CONSTRAINT PK_GD PRIMARY KEY (MALOP,MAMH)

ALTER TABLE KETQUATHI 
ADD CONSTRAINT PK_KQT PRIMARY KEY (MAHV,MAMH,LANTHI)

--TAO KHOA NGOAI

USE QuanLyGiaoVu

ALTER TABLE HOCVIEN 
ADD CONSTRAINT FK_HV_ML FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE MONHOC 
ADD CONSTRAINT FK_MH_MK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE	GIAOVIEN 
ADD CONSTRAINT FK_GV_MK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE	GIANGDAY 
ADD CONSTRAINT FK_GD_MGV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE KHOA 
ADD CONSTRAINT FK_KHOA_TK FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)
-- THEM THUOC TINH VAO BANG HOCVIEN

ALTER TABLE HOCVIEN ADD
	GHICHU nvarchar(200),
	DIEMTB numeric(4,2),
	XEPLOAI varchar(20)

--CAU I.2-----------------------------------------------


--CAU I.3 DUNG RANG BUOC CHECK CHO THUOC TINH GIOITINH-----------------------------------------------
ALTER TABLE HOCVIEN 
ADD CONSTRAINT CK_GT 
CHECK (GIOITINH IN ('Nam','Nu'))

--CAU I.4-----------------------------------------------
ALTER TABLE KETQUATHI 
ADD CONSTRAINT CK_DIEM 
CHECK (DIEM >= 0 AND DIEM <= 10)

--CAU I.5-----------------------------------------------
ALTER TABLE KETQUATHI 
ADD CONSTRAINT CK_KQ 
CHECK ((KQUA = 'Dat' AND DIEM >= 5 AND DIEM <= 10) 
	OR (KQUA = 'Khong dat' AND DIEM < 5))

--CAU I.6-----------------------------------------------
ALTER TABLE KETQUATHI 
ADD CONSTRAINT CK_LT 
CHECK (LANTHI >= 0 AND LANTHI <= 3)

--CAU I.7-----------------------------------------------
ALTER TABLE GIANGDAY 
ADD CONSTRAINT CK_HK 
CHECK (HOCKI >= 1 AND HOCKI <= 3)

--CAU I.8-----------------------------------------------
ALTER TABLE GIAOVIEN 
ADD CONSTRAINT CK_HV 
CHECK (HOCVI IN('CN','KS','Ths','TS','PTS'))


--XOA RBTV CHECK
ALTER TABLE GIAOVIEN 
DROP CONSTRAINT CK_HV

ALTER TABLE HOCVIEN 
DROP CONSTRAINT CK_GT




----------------------------------------------------------------------------------------------------------------------------------------------




--TUAN 02--

--BAI TAP 02-----------------------------------------------

--NHAP DU LIEU CHO CSDL QuanLyGiaoVu

--XOA KHOA NGOAI TRUOC KHI INSERT DATA 
ALTER TABLE GIAOVIEN 
DROP CONSTRAINT FK_GV_MK

ALTER TABLE GIANGDAY 
DROP CONSTRAINT FK_GD_MGV

ALTER TABLE KHOA 
DROP CONSTRAINT FK_KHOA_TK

--SAU KHI INSERT XONG PHARI TAO LAI CAC KHOA NGOAI

--NHAP DATA CHO TABLE KHOA

INSERT INTO KHOA VALUES ('KHMT','Khoa hoc may tinh','7/6/2005','GV01')
INSERT INTO KHOA VALUES ('HTTT','He thong thong tin','7/6/2005','GV02')
INSERT INTO KHOA VALUES ('CNPM','Cong nghe phan mem','7/6/2005','GV04')
INSERT INTO KHOA VALUES ('MTT','Mang va truyen thong','20/10/2005','GV03')
INSERT INTO KHOA VALUES ('KTMT','Ky thuat may tinh','20/12/2005',Null)

SELECT *FROM KHOA

--NHAP DATA CHO TABLE KHOA
INSERT INTO LOP VALUES ('K11','Lop 1 khoa 1','K1108',11,'GV07')
INSERT INTO LOP VALUES ('K12','Lop 2 khoa 1','K1205',12,'GV09')
INSERT INTO LOP VALUES ('K13','Lop 3 khoa 1','K1305',12,'GV14')

SELECT *FROM LOP

--NHAP DATA CHO TABLE MONHOC
INSERT INTO MONHOC VALUES ('THDC','Tin hoc dai cuong',4,1,'KHMT')
INSERT INTO MONHOC VALUES ('CTRR','Cau truc roi rac',5,0,'KHMT')
INSERT INTO MONHOC VALUES ('CSDL','Co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES ('CTDLGT','Cau truc du lieu va giai thuat',3,1,'KHMT')
INSERT INTO MONHOC VALUES ('PTTKTT','Phan tich thiet ke thuat toan',3,0,'KHMT')
INSERT INTO MONHOC VALUES ('DHMT','Do hoa may tinh',3,1,'KHMT')
INSERT INTO MONHOC VALUES ('KTMT','Kien truc may tinh',3,0,'KTMT')
INSERT INTO MONHOC VALUES ('TKCSDL','Thiet ke co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES ('PTTKHTTT','Phan tich thiet ke he thong thong tin',4,1,'HTTT')
INSERT INTO MONHOC VALUES ('HDH','He dieu hanh',4,0,'KTMT')
INSERT INTO MONHOC VALUES ('NMCNPM','Nhap mon cong nghe phan mem',3,0,'CNPM')
INSERT INTO MONHOC VALUES ('LTCFW','Lap trinh C for win',3,1,'CNPM')
INSERT INTO MONHOC VALUES ('LTHDT','Lap trinh huong doi tuong',3,1,'CNPM')

SELECT *FROM MONHOC

--NHAP DATA CHO TABLE GIANGDAY
INSERT INTO GIANGDAY VALUES ('K11','THDC','GV07',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','THDC','GV06', 1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','THDC','GV15',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTRR','GV08',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CSDL','GV05',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K12','CSDL','GV09',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTDLGT','GV15',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CSDL','GV05',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K13','DHMT','GV07',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','HDH','GV04',1,2007,'2/1/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES ('K12','HDH','GV04',1,2007,'2/1/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES ('K11','DHMT','GV07',1,2007,'18/2/2007','20/3/2007')

SELECT *FROM GIANGDAY

--NHAP DATA CHO TABLE GIAOVIEN
INSERT INTO GIAOVIEN VALUES ('GV01','Ho Thanh Son','PTS','GS','Nam','2/5/1950','11/1/2004',5.00, 2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV02','Tran Tam Thanh','TS','PGS','Nam','17/12/1965','20/4/2004',4.50,2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV03','Do Nghiem Phung','TS','GS','Nu','1/8/1950','23/9/2004',4.00,1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV04','Tran Nam Son','TS','PGS','Nam','22/2/1961','12/1/2005',4.50,2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV05','Mai Thanh Danh','ThS','GV','Nam','12/3/1958','12/1/2005',3.00,1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV06','Tran Doan Hung','TS','GV','Nam','11/3/1953','12/1/2005',4.50,2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','1/3/2005',4.00,1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV08','Le Thi Tran','KS',Null,'Nu','26/3/1974','1/3/2005',1.69,760500,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','1/3/2005',4.00,1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV10','Le Tran Anh Loan','KS',Null,'Nu','17/7/1972','1/3/2005',1.86,837000,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV11','Ho Thanh Tung','CN','GV','Nam','12/1/1980','15/5/2005',2.67,1201500,'MTT')
INSERT INTO GIAOVIEN VALUES ('GV12','Tran Van Anh','CN',Null,'Nu','29/3/1981','15/5/2005',1.69,760500,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV13','Nguyen Linh Dan','CN',Null,'Nu','23/5/1980','15/5/2005',1.69,760500,'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/5/2005',3.00,1350000,'MTT')
INSERT INTO GIAOVIEN VALUES ('GV15','Le Ha Thanh','ThS','GV','Nam','4/5/1978','15/5/2005',3.00,1350000,'KHMT')

SELECT *FROM GIAOVIEN

--NHAP DATA CHO TABLE DIEUKIEN

INSERT INTO DIEUKIEN VALUES ('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES ('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES ('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKHTTT','CSDL')

SELECT *FROM DIEUKIEN

--NHAP DATA CHO TABLE KETQUATHI

INSERT INTO KETQUATHI VALUES ('K1101','CSDL',1,'20/7/2006',10.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTDLGT',1,'28/12/2006',9.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','THDC',1,'20/5/2006',9.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTRR',1,'13/5/2006',9.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',1,'20/7/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',2,'27/7/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',3,'10/8/2006',4.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',1,'28/12/2006',4.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',2,'5/1/2007',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',3,'15/1/2007',6.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','THDC',1,'20/5/2006',5.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTRR',1,'13/5/2006',7.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL',1,'20/7/2006',3.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL',2,'27/7/2006',8.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTDLGT',1,'28/12/2006',7.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','THDC',1,'20/5/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTRR',1,'13/5/2006',6.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CSDL',1,'20/7/2006',3.75,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTDLGT',1,'28/12/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','THDC',1,'20/5/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',1,'13/5/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',2,'20/5/2006',3.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',3,'30/6/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CSDL',1,'20/7/2006',6.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTDLGT',1,'28/12/2006',5.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','THDC',1,'20/5/2006',8.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTRR',1,'13/5/2006',9.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CSDL',1,'20/7/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT',1,'28/12/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT',2,'5/1/2007',5.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC',1,'20/5/2006', 4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC',2,'27/5/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',1,'13/5/2006',3.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',2,'20/5/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',3,'30/6/2006',6.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CSDL',1,'20/7/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTDLGT',1,'28/12/2006',9.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','THDC',1,'20/5/2006',10.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTRR',1,'13/5/2006',10.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CSDL',1,'20/7/2006',8.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTDLGT',1,'28/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','THDC',1,'20/5/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTRR',1,'13/5/2006',6.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CSDL',1,'20/12/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTDLGT',1,'25/7/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','THDC',1,'20/5/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTRR',1,'13/5/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CSDL',1,'20/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTDLGT',1,'25/7/2006',5.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','THDC',1,'20/5/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTRR',1,'13/5/2006',8.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CSDL',1,'20/12/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',1,'25/7/2006',4.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',2,'7/8/2006',4.00,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',3,'15/8/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','THDC',1,'20/5/2006',4.50,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR',1,'13/5/2006',3.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR',2,'20/5/2006',5.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CSDL',1,'20/12/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTDLGT',1,'25/7/2006',9.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','THDC',1,'20/5/2006',5.50,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTRR',1,'13/5/2006',5.00,' Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CSDL',1,'20/12/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTDLGT',1,'25/7/2006',10.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','THDC',1,'20/5/2006',8.00,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTRR',1,'13/5/2006',10.00,'Dat')

SELECT *FROM KETQUATHI

--NHAP DATA CHO TABLE HOCVIEN
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1103','Ha Duy','Lap','18/4/1986','Nam','Nghe An','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1104','Tran Ngoc','Linh','30/3/1986','Nu','Tay Ninh','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1105','Tran Minh','Long','27/2/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1106','Le Nhat','Minh','24/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1107','Nguyen Nhu','Nhut','27/1/1986','Nam','Ha Noi','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1108','Nguyen Manh','Tam','27/2/1986','Nam','Kien Giang','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1109','Phan Thi Thanh','Tam','27/1/1986','Nu','Vinh Long','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1110','Le Hoai','Thuong','5/2/1986','Nu','Can Tho','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1201','Nguyen Van','B','11/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1202','Nguyen Thi Kim','Duyen','18/1/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1203','Tran Thi Kim','Duyen','17/9/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1204','Truong My','Hanh','19/5/1986','Nu','Dong Nai','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1205','Nguyen Thanh','Nam','17/4/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1206','Nguyen Thi Truc','Thanh','4/3/1986','Nu','Kien Giang','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1207','Tran Thi Bich','Thuy','8/2/1986','Nu','Nghe An','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1208','Huynh Thi Kim','Trieu','8/4/1986','Nu','Tay Ninh','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1209','Pham Thanh','Trieu','23/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1210','Ngo Thanh','Tuan','14/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1211','Do Thi','Xuan','9/3/1986','Nu','Ha Noi','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1212','Le Thi Phi','Yen','12/3/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1301','Nguyen Thi Kim','Cuc','9/6/1986','Nu','Kien Giang','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1302','Truong Thi My','Hien','18/3/1986','Nu','Nghe An','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1303','Le Duc','Hien','21/3/1986','Nam','Tay Ninh','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1304','Le Quang','Hien','18/4/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1305','Le Thi','Huong','27/3/1986','Nu','TpHCM','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1306','Nguyen Thai','Huu','30/3/1986','Nam','Ha Noi','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1307','Tran Minh','Man','28/5/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1308','Nguyen Hieu','Nghia','8/4/1986','Nam','Kien Giang','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1309','Nguyen Trung','Nghia','18/1/1987','Nam','Nghe An','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1310','Tran Thi Hong','Tham','22/4/1986','Nu','Tay Ninh','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1311','Tran Minh','Thuc','4/4/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1312','Nguyen Thi Kim','Yen','7/9/1986','Nu','TpHCM','K13')

SELECT *FROM HOCVIEN

--BAI TAP 04
--SU DUNG CAU LENH CHECK CHO CAU I.11 -> I.14

--CAU I.11-----------------------------------------------

ALTER TABLE HOCVIEN 
ADD CONSTRAINT CK_TUOI_HV 
CHECK (YEAR(GETDATE())-YEAR(NGSINH) >= 18)

--CAU I.12-----------------------------------------------

ALTER TABLE GIANGDAY 
ADD CONSTRAINT CK_NGAY 
CHECK (TUNGAY < DENNGAY)

--CAU I.13-----------------------------------------------

ALTER TABLE GIAOVIEN 
ADD CONSTRAINT CK_TUOI_GV 
CHECK (YEAR(GETDATE())-YEAR(NGSINH) >= 22)

--CAU I.14-----------------------------------------------
--XOA DU LIEU TRONG BANG TRUOC KHI TAO RANG BUOC CHECK

DELETE FROM MONHOC 

ALTER TABLE MONHOC 
ADD CONSTRAINT CK_TC 
CHECK (ABS(TCLT-TCTH) <= 3)

--SAU DO CHAY LAI LENH INSERT



----------------------------------------------------------------------------------------------------------------------------------------------






--TUAN 03--

---BAI TAP 02---
--CAU II.1-----------------------------------------------
UPDATE GIAOVIEN 
SET HESO = HESO + 0.2
WHERE GIAOVIEN.MAGV = (SELECT KHOA.TRGKHOA
						FROM  KHOA
						WHERE GIAOVIEN.MAGV = KHOA.TRGKHOA)

SELECT *FROM GIAOVIEN

--CAU II.2-----------------------------------------------
-- LAY DIEM TRUNG BINH CUA TUNG HOC VIEN
SELECT MAHV, AVG(DIEM)
FROM KETQUATHI T1
WHERE LANTHI = (SELECT TOP 1 LANTHI -- LAY LAN THI CUOI CUNG CUA TUNG MON
				FROM KETQUATHI T2
				WHERE T2.MAMH = T1.MAMH
					AND T2.MAHV = T1.MAHV
				GROUP BY T2.MAMH, T2.LANTHI, T2.MAHV
				ORDER BY LANTHI DESC)
GROUP BY T1.MAHV

UPDATE HOCVIEN
SET DIEMTB = (SELECT AVG(DIEM)
				FROM KETQUATHI T1
				WHERE LANTHI = (SELECT TOP 1 LANTHI 
								FROM KETQUATHI T2
								WHERE T2.MAMH = T1.MAMH
									AND T2.MAHV = T1.MAHV
								GROUP BY T2.MAMH, T2.LANTHI, T2.MAHV
								ORDER BY LANTHI DESC)
					AND HOCVIEN.MAHV = T1.MAHV
				GROUP BY T1.MAHV)

SELECT *FROM HOCVIEN
--CAU II.3-----------------------------------------------
UPDATE HOCVIEN
SET GHICHU = 'Cam thi'
WHERE MAHV IN (SELECT MAHV
				FROM KETQUATHI 
				WHERE LANTHI = 3
					AND DIEM < 5)

SELECT *FROM HOCVIEN 

--CAU II.4-----------------------------------------------
UPDATE HOCVIEN
SET XEPLOAI = 'XS'
WHERE DIEMTB >=9 

UPDATE HOCVIEN
SET XEPLOAI = 'G'
WHERE DIEMTB >=8 
	AND DIEMTB < 9

UPDATE HOCVIEN
SET XEPLOAI = 'K'
WHERE DIEMTB >=6.5
	AND DIEMTB < 8

UPDATE HOCVIEN
SET XEPLOAI = 'TB'
WHERE DIEMTB >=5
	AND DIEMTB < 6.5

UPDATE HOCVIEN
SET XEPLOAI = 'Y'
WHERE DIEMTB < 5

SELECT *FROM HOCVIEN
---BAI TAP 03---
--CAU III.6-----------------------------------------------
--Cach 1
SELECT TENMH
FROM MONHOC
WHERE MAMH IN (SELECT MAMH
				FROM GIANGDAY JOIN GIAOVIEN
				ON GIANGDAY.MAGV = GIAOVIEN.MAGV
				WHERE GIAOVIEN.HOTEN = 'Tran Tam Thanh'
				AND GIANGDAY.HOCKI = 1 
				AND GIANGDAY.NAM = 2006)

--Cach 2
SELECT DISTINCT TENMH
FROM MONHOC JOIN GIANGDAY 
ON MONHOC.MAMH = GIANGDAY.MAMH
JOIN GIAOVIEN 
ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE GIAOVIEN.HOTEN = 'Tran Tam Thanh'
	AND GIANGDAY.HOCKI = 1 
	AND GIANGDAY.NAM = 2006 

--CAU III.7-----------------------------------------------
SELECT DISTINCT MONHOC.MAMH, TENMH
FROM MONHOC JOIN GIANGDAY
ON MONHOC.MAMH = GIANGDAY.MAMH
JOIN LOP 
ON LOP.MAGVCN = GIANGDAY.MAGV
WHERE LOP.MALOP = 'K11'
	AND GIANGDAY.HOCKI = 1 
	AND GIANGDAY.NAM = 2006 

--CAU III.8-----------------------------------------------
SELECT DISTINCT HO, TEN 
FROM HOCVIEN JOIN LOP
ON HOCVIEN.MAHV = LOP.TRGLOP
JOIN GIANGDAY
ON GIANGDAY.MAGV = LOP.MAGVCN
JOIN GIAOVIEN
ON GIAOVIEN.MAGV = GIANGDAY.MAGV
JOIN MONHOC
ON MONHOC.MAMH = GIANGDAY.MAMH
WHERE HOTEN = 'Nguyen To Lan'
	AND TENMH = 'Co So Du Lieu'

--CAU III.9-----------------------------------------------
SELECT MAMH, TENMH
FROM MONHOC
WHERE MAMH IN (SELECT MAMH_TRUOC
				FROM DIEUKIEN
				WHERE MAMH IN (SELECT MAMH 
								FROM MONHOC
								WHERE TENMH = 'Co So Du Lieu'))
	
--CAU III.10-----------------------------------------------
--VI MON CTRR KHONG THOA LENH CHECK TRONG CAC CAU TREN NEN MON CTRR KHONG CO TRONG TABLE MON HOC
--NEN KET QUA RONG
SELECT MAMH, TENMH
FROM MONHOC
WHERE MAMH IN (SELECT MAMH
				FROM DIEUKIEN
				WHERE MAMH_TRUOC IN (SELECT MAMH 
									FROM MONHOC
									WHERE TENMH = 'Cau Truc Roi Rac'))

---BAI TAP 05---
--CAU III.11-----------------------------------------------
SELECT DISTINCT HOTEN
FROM GIAOVIEN JOIN GIANGDAY 
ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE GIANGDAY.NAM = 2006
	AND GIANGDAY.HOCKI = 1
	AND MAMH = 'CTRR'
	AND GIANGDAY.MALOP IN ('K11', 'K12')

--CAU III.12-----------------------------------------------
SELECT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN
WHERE MAHV IN (SELECT MAHV
				FROM KETQUATHI
				WHERE MAMH = 'CSDL'
					AND KQUA = 'Khong Dat'
				EXCEPT 
				SELECT DISTINCT MAHV
				FROM KETQUATHI
				WHERE MAMH = 'CSDL'
					AND LANTHI > 1)

SELECT *FROM KETQUATHI
--CAU III.13-----------------------------------------------
SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN 
EXCEPT 
SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
WHERE MAGV IN (SELECT DISTINCT MAGV
				FROM GIANGDAY)

--CAU III.14-----------------------------------------------
SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE MAKHOA NOT IN (SELECT DISTINCT MAKHOA
				FROM MONHOC 
				WHERE MONHOC.MAMH IN (SELECT DISTINCT MAMH
										FROM GIANGDAY))

--CAU III.15-----------------------------------------------
SELECT HO, TEN
FROM HOCVIEN
WHERE MALOP IN (SELECT DISTINCT MALOP
				FROM LOP
				WHERE MALOP = 'k11')
	AND MAHV IN (SELECT DISTINCT MAHV
				FROM KETQUATHI
				WHERE LANTHI > 2 
					AND KQUA = 'Khong Dat'
					OR (LANTHI IN (SELECT DISTINCT LANTHI
									FROM KETQUATHI 
									WHERE LANTHI = 2
										AND DIEM = 5)) 
							AND MAMH = 'CTRR') 

--CAU III.16-----------------------------------------------
SELECT HOTEN
FROM GIAOVIEN
WHERE MAGV IN (SELECT MAGV 
				FROM GIANGDAY T1
				WHERE MAMH = 'CTRR'
					AND MAGV IN (SELECT MAGV
								FROM GIANGDAY T2
								WHERE MAMH = 'CTRR'
									AND T1.HOCKI = T2.HOCKI
									AND YEAR(T1.NAM) = YEAR(T2.NAM))
				GROUP BY MAGV
				HAVING COUNT(MAMH) > 1)

--CAU III.17-----------------------------------------------
SELECT HOCVIEN.MAHV, HO, TEN, DIEM
FROM KETQUATHI T1 LEFT JOIN HOCVIEN 
ON T1.MAHV = HOCVIEN.MAHV
WHERE LANTHI = (SELECT TOP 1 LANTHI -- LAY LAN THI CUOI CUNG CUA TUNG MON
				FROM KETQUATHI T2
				WHERE T2.MAMH = T1.MAMH
					AND T2.MAHV = T1.MAHV
				GROUP BY T2.MAMH, T2.LANTHI, T2.MAHV
				ORDER BY LANTHI DESC)
	AND MAMH = 'CSDL'

--CAU III.18-----------------------------------------------
SELECT HOCVIEN.MAHV, HO, TEN, DIEM
FROM KETQUATHI T1 LEFT JOIN HOCVIEN 
ON T1.MAHV = HOCVIEN.MAHV
WHERE DIEM = (SELECT MAX(DIEM) -- LAY LAN THI CUOI CUNG CUA TUNG MON
				FROM KETQUATHI T2
				WHERE T2.MAMH = T1.MAMH
					AND T2.MAHV = T1.MAHV
				GROUP BY T2.MAMH, T2.MAHV)
	AND MAMH = 'CSDL'


----------------------------------------------------------------------------------------------------------------------------------------------	







--TUAN 04--

---BAI TAP 02---

--CAU III.19-----------------------------------------------
SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE NGTLAP IN (SELECT TOP 1 NGTLAP
					FROM KHOA
					ORDER BY NGTLAP ASC)

--CAU III.20-----------------------------------------------
SELECT COUNT(*) AS 'GS or PGS'
FROM GIAOVIEN
WHERE HOCHAM IN ('GS','PGS')

--CAU III.21-----------------------------------------------
--THONG KE CU NHAN
SELECT MAKHOA, COUNT(HOCVI) AS CUNHAN
FROM GIAOVIEN
WHERE HOCVI IN ('CN')
GROUP BY MAKHOA
--THONG KE KI SU
SELECT MAKHOA, COUNT(HOCVI) AS KISU
FROM GIAOVIEN
WHERE HOCVI IN ('KS')
GROUP BY MAKHOA
--THONG KE THAC SI
SELECT MAKHOA, COUNT(HOCVI) AS Ths
FROM GIAOVIEN
WHERE HOCVI IN ('Ths')
GROUP BY MAKHOA
--THONG KE TIEN SI
SELECT MAKHOA, COUNT(HOCVI) AS TS
FROM GIAOVIEN
WHERE HOCVI IN ('TS')
GROUP BY MAKHOA
--THONG KE PTS
SELECT MAKHOA, COUNT(HOCVI) AS PTS
FROM GIAOVIEN
WHERE HOCVI IN ('PTS')
GROUP BY MAKHOA

--CAU III.22-----------------------------------------------
--THONG KE SO LUONG HOC VIEN DAT THEO TUNG MON HOC
SELECT MAMH, COUNT(KQUA) AS KQ_DAT
FROM KETQUATHI T1 LEFT JOIN HOCVIEN 
ON T1.MAHV = HOCVIEN.MAHV
WHERE LANTHI = (SELECT TOP 1 LANTHI -- LAY LAN THI CUOI CUNG CUA TUNG MON
				FROM KETQUATHI T2
				WHERE T2.MAMH = T1.MAMH
					AND T2.MAHV = T1.MAHV
				GROUP BY T2.MAMH, T2.LANTHI, T2.MAHV
				ORDER BY LANTHI DESC)
	AND KQUA = 'Dat'
GROUP BY MAMH
--THONG KE SO LUONG HOC VIEN KHONG DAT THEO TUNG MON HOC
SELECT MAMH, COUNT(KQUA) AS KQ_KHONG_DAT
FROM KETQUATHI T1 LEFT JOIN HOCVIEN 
ON T1.MAHV = HOCVIEN.MAHV
WHERE LANTHI = (SELECT TOP 1 LANTHI -- LAY LAN THI CUOI CUNG CUA TUNG MON
				FROM KETQUATHI T2
				WHERE T2.MAMH = T1.MAMH
					AND T2.MAHV = T1.MAHV
				GROUP BY T2.MAMH, T2.LANTHI, T2.MAHV
				ORDER BY LANTHI DESC)
	AND KQUA = 'Khong Dat'
GROUP BY MAMH

--CAU III.23-----------------------------------------------

--SAI
SELECT MAGV, HOTEN 
FROM GIAOVIEN
WHERE MAGV IN (SELECT MAGVCN
				FROM LOP)
	AND MAGV IN (SELECT LOP.MAGVCN
				FROM  LOP
				WHERE LOP.MALOP IN (SELECT GIANGDAY.MALOP 
									FROM GIANGDAY 
									WHERE GIANGDAY.MALOP = LOP.MALOP
									GROUP BY MAGV, GIANGDAY.MALOP
									HAVING COUNT(MAGV) > 1))
							
--CAU III.24-----------------------------------------------
SELECT HO,TEN
FROM HOCVIEN 
WHERE MAHV IN (SELECT TRGLOP
				FROM LOP 
				WHERE SISO IN (SELECT MAX(SISO)
								FROM LOP))

--CAU III.25-----------------------------------------------
SELECT HO, TEN
FROM HOCVIEN
WHERE MAHV IN (SELECT TRGLOP
				FROM LOP
				WHERE TRGLOP IN (SELECT MAHV
								FROM KETQUATHI
								WHERE KQUA = 'Khong Dat'
								GROUP BY MAHV
								HAVING COUNT(DISTINCT MAMH) > 3))

---BAI TAP 04---

--CAU III.26-----------------------------------------------
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE MAHV IN (SELECT MAHV 
				FROM KETQUATHI
				WHERE DIEM >= 9 
					AND DIEM <= 10 
				GROUP BY MAHV
				HAVING COUNT(*) = (SELECT TOP 1 COUNT(*)
									FROM KETQUATHI
									WHERE DIEM >= 9 
										AND DIEM <= 10 
									GROUP BY MAHV
									ORDER BY COUNT(*) DESC))

--CAU III.27-----------------------------------------------




--CAU III.28-----------------------------------------------




--CAU III.29-----------------------------------------------




--CAU III.30-----------------------------------------------
SELECT MAMH, TENMH
FROM MONHOC
WHERE MAMH IN (SELECT MAMH
				FROM KETQUATHI
				WHERE LANTHI = 1
					AND KQUA = 'Khong Dat'
				GROUP BY MAMH
				HAVING COUNT(*) IN (SELECT TOP 1 COUNT(*)
									FROM KETQUATHI
									WHERE  LANTHI = 1
										AND KQUA = 'Khong Dat' 
									GROUP BY MAMH
									ORDER BY COUNT(*) DESC))

--CAU III.31-----------------------------------------------
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE MAHV IN (SELECT MAHV 
				FROM KETQUATHI
				WHERE LANTHI = 1
					AND KQUA = 'Dat'
				GROUP BY MAHV
				HAVING COUNT(*) = (SELECT TOP 1 COUNT(*)
									FROM KETQUATHI
									WHERE LANTHI = 1
										AND KQUA = 'Dat'
									GROUP BY MAHV
									ORDER BY COUNT(*) DESC))

--CAU III.32-----------------------------------------------




--CAU III.33-----------------------------------------------




--CAU III.34-----------------------------------------------



--CAU III.35-----------------------------------------------


----------------------------------------------------------------------------------------------------------------------------------------------






--TUAN 05--

---BAI TAP 02---

--CAU I.9-----------------------------------------------
CREATE TRIGGER TRG_INS_LOP ON LOP
FOR INSERT 
AS
BEGIN
	DECLARE @MaLopTruong CHAR(5), @MaLop CHAR(3)
	SELECT @MaLop = MALOP
	FROM INSERTED

	SELECT @MaLopTruong = TRGLOP
	FROM LOP
	WHERE @MaLop = MALOP

	IF (CHARINDEX( @MaLop, @MaLopTruong,1) <> 1)
	BEGIN
		PRINT 'LOI: LOP TRUONG KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'THEM MOI MOT LOP TRUONG THANH CONG'
	END
END 

--CAU I.10-----------------------------------------------
CREATE TRIGGER TRG_INS_KHOA ON KHOA
FOR INSERT 
AS
BEGIN
	DECLARE @MaTruongKhoa CHAR(4), @MaKhoa CHAR(4), @HocVi CHAR(10), @MaGV CHAR(4)
	SELECT @MaTruongKhoa = TRGKHOA, @MaKhoa = MAKHOA
	FROM INSERTED

	SELECT @HocVi = HOCVI
	FROM GIAOVIEN
	WHERE MAGV = @MaTruongKhoa

	SELECT @MaGV = TRGKHOA
	FROM KHOA
	WHERE MAKHOA = @MaKhoa

	IF ((SELECT MAKHOA 
			FROM GIAOVIEN
			WHERE @MaTruongKhoa = @MaGV)<> @MaKhoa OR @MaTruongKhoa <> @MaGV OR @HocVi NOT IN ('TS','PTS'))
	BEGIN
		PRINT 'LOI: TRUONG KHOA KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'THEM MOI MOT TRUONG KHOA THANH CONG'
	END
END 

--CAU I.15-----------------------------------------------
CREATE TRIGGER TRG_INS_KQT ON KETQUATHI
FOR INSERT
AS
BEGIN
	DECLARE @MaHV CHAR(5), @MaLop CHAR (3),
			@NgayThi SMALLDATETIME, @NgayKTKH SMALLDATETIME
	SELECT @MaHV = MAHV, @NgayThi = NGTHI
	FROM INSERTED 

	SELECT @MaLop = MALOP
	FROM GIANGDAY
	WHERE @MaHV = (SELECT MAHV
					FROM HOCVIEN 
					WHERE MAHV = @MaHV)

	SELECT @NgayKTKH = DENNGAY
	FROM GIANGDAY
	WHERE MALOP = @MaLop

	IF (@NgayThi < @NgayKTKH)
		BEGIN
			PRINT 'LOI: NGAY THI VA NGAY KET THUC KHOA HOC KHONG HOP LE'
			ROLLBACK TRANSACTION
		END 
	ELSE
	BEGIN
		PRINT 'THEM MOT KET QUA THI THANH CONG'
	END
END

--CAU I.16-----------------------------------------------
CREATE TRIGGER TRG_INS_GD ON GIANGDAY
FOR INSERT
AS
BEGIN
	DECLARE @SoMonHoc INT, @MaLop CHAR(3)
	SELECT @MaLop = MALOP
	FROM INSERTED

	SELECT @SoMonHoc = COUNT(MAMH)
	FROM GIANGDAY GD1
	WHERE HOCKI IN (SELECT HOCKI 
					FROM GIANGDAY GD2
					WHERE GD1.NAM = GD2.NAM
						AND GD1.HOCKI = GD2.HOCKI)
	GROUP BY MALOP,HOCKI,NAM

	IF (@SoMonHoc > 3)
	BEGIN
		PRINT 'LOI: MOT HOC KY MOT LOP KHONG DUOC HOC NHIEU HON 3 MON'
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT'THEM MOT GIANG DAY THANH CONG'
	END
END

--CAU I.17-----------------------------------------------
CREATE TRIGGER TRG_INS_SSLOP ON LOP
FOR INSERT
AS
BEGIN
	DECLARE @SoLuongHocVien INT, @MaLop CHAR(3), @SiSo INT
	SELECT @MaLop = MALOP, @SiSo = SISO
	FROM INSERTED

	SELECT @SoLuongHocVien = COUNT(MALOP)
	FROM HOCVIEN HV1
	WHERE MALOP IN (SELECT MALOP 
					FROM HOCVIEN HV2
					WHERE HV2.MALOP = HV1.MALOP)
	GROUP BY MALOP

	IF (@SoLuongHocVien <> @SiSo)
	BEGIN 
		PRINT'LOI: SI SO KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
	ELSE 
	BEGIN
		PRINT'THEM SI SO LOP THANH CONG'
	END
END

--CAU I.18-----------------------------------------------


--CAU I.19-----------------------------------------------


--CAU I.20-----------------------------------------------


--CAU I.21-----------------------------------------------
CREATE TRIGGER TRG_INS_KQT_NT ON KETQUATHI
FOR INSERT 
AS
BEGIN
	DECLARE @MaHV CHAR(5), @MaMH CHAR(10), @NgayThiTruoc SMALLDATETIME, @NgayThiSau SMALLDATETIME
	SELECT @MaHV = MAHV, @MaMH = MAMH
	FROM INSERTED

	SELECT @NgayThiTruoc = NGTHI
	FROM KETQUATHI KQT1
	WHERE MAMH IN (SELECT MAMH
					FROM KETQUATHI KQT2
					WHERE KQT1.MAHV = KQT2.MAHV
						AND KQT1.LANTHI = 1
						AND KQT1.MAMH = KQT2.MAMH)

	SELECT @NgayThiSau = NGTHI
	FROM KETQUATHI KQT1
	WHERE MAMH IN (SELECT MAMH
					FROM KETQUATHI KQT2
					WHERE KQT1.MAHV = KQT2.MAHV
						AND KQT1.LANTHI <> 1
						AND KQT1.MAMH = KQT2.MAMH)

	IF(@NgayThiSau < @NgayThiTruoc)
	BEGIN
		PRINT'LOI: NGAY THI SAU KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT'THEM MOT KET QUA THI THANH CONG'
	END
END

--CAU I.22-----------------------------------------------
--Tương Tự Câu I.15 


--CAU I.23-----------------------------------------------




--CAU I.24-----------------------------------------------
CREATE TRIGGER TRG_INS_GD_GV ON GIANGDAY
FOR INSERT
AS
BEGIN
	DECLARE @MaGV CHAR(4), @MaKhoaMH CHAR(4),@MaKhoaGV CHAR(4), @MaMH CHAR(10)
	SELECT @MaGV = MAGV, @MaMH = MAMH
	FROM INSERTED

	SELECT @MaKhoaGV = MAKHOA
	FROM GIAOVIEN
	WHERE @MaGV = MAGV

	SELECT @MaKhoaMH = MAKHOA
	FROM MONHOC
	WHERE @MaMH = MAMH

	IF(@MaKhoaGV <> @MaKhoaMH)
	BEGIN
		PRINT'LOI: GIAO VIEN DAY MON KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
	ELSE
	PRINT'THEM MOT GIAO VIEN GIANG DAY THANH CONG'
END
